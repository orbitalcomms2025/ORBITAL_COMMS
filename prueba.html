<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Orbital Comms - Login & Phone Info</title>
<style>
  body { font-family: Arial,sans-serif; background:#101820; color:#f2f2f2; text-align:center; padding:50px; }
  .container { max-width:500px; margin:auto; background:#1c1c1c; padding:30px; border-radius:15px; box-shadow:0 0 15px rgba(0,255,255,0.3); margin-bottom:30px; }
  input, textarea { display:block; margin:10px auto; padding:10px; width:90%; border-radius:5px; border:none; }
  button { padding:10px 20px; border-radius:5px; border:none; cursor:pointer; background-color:#00ffff; font-weight:bold; }
  button:hover { background-color:#00cccc; }
  .message { margin-top:15px; font-weight:bold; }
  .link { color:#00ffff; cursor:pointer; text-decoration:underline; margin-top:10px; display:block; }
  .hidden { display:none; }
  hr { border-color:#00ffff; margin:20px 0; }
</style>
</head>
<body>

<!-- AUTH CONTAINER -->
<div class="container" id="authContainer">
  <h1>üöÄ Orbital Comms</h1>

  <form id="loginForm">
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit">Login</button>
  </form>

  <form id="registerForm" class="hidden">
    <input type="text" id="name" placeholder="Full Name" required>
    <input type="email" id="regEmail" placeholder="Email" required>
    <input type="password" id="regPassword" placeholder="Password" required>
    <button type="submit">Register</button>
  </form>

  <span id="toggleForm" class="link">No account? Register here</span>
  <div id="message" class="message"></div>
</div>

<!-- PHONE CONTAINER -->
<div class="container hidden" id="phoneContainer">
  <h2>üì± Phone Information</h2>

  <!-- CURRENT PHONE SECTION -->
  <div id="currentPhoneSection" class="hidden">
    <p>Your current phone number is: <strong id="currentPhone"></strong></p>
    <button id="confirmPhoneBtn">Confirm</button>
    <button id="editPhoneBtn">Register Another Number</button>
  </div>

  <!-- PHONE FORM -->
  <form id="phoneForm" class="hidden">
    <input type="text" id="phoneNumber" placeholder="Phone Number" required>
    <input type="text" id="country" placeholder="Country" required>
    <input type="text" id="phoneCity" placeholder="City of Residence" required>
    <button type="submit">Save Phone Info</button>
  </form>
  <div id="phoneMessage" class="message"></div>
</div>

<!-- WHATSAPP/SANDBOX CONTAINER -->
<div class="container hidden" id="whatsappContainer">
  <h2>üí¨ Send WhatsApp Message</h2>
  <textarea id="whatsappMessage" placeholder="Type your message here" rows="4" style="width:90%; margin:10px auto;"></textarea>
  <button id="sendWhatsappBtn">Send WhatsApp Message</button>
  <div id="whatsappStatus" class="message"></div>

  <hr>

  <h2>üì© Twilio Sandbox Status</h2>
  <div id="sandboxStatus" class="message"></div>
  <button id="getSandboxInviteBtn">Get Sandbox Invite</button>
  <p id="sandboxGuide" class="message hidden">
    ‚ö†Ô∏è Not registered in Sandbox yet.<br>
    Copy <strong>join disappear-tip</strong> and paste it in your WhatsApp chat with Twilio Sandbox number to register.
  </p>
  <a id="sandboxLink" href="#" target="_blank" class="hidden">Click here to join Sandbox</a>
</div>

<script>
const API = "https://local-data.onrender.com";
const authContainer = document.getElementById("authContainer");
const phoneContainer = document.getElementById("phoneContainer");
const whatsappContainer = document.getElementById("whatsappContainer");

const loginForm = document.getElementById("loginForm");
const registerForm = document.getElementById("registerForm");
const toggleForm = document.getElementById("toggleForm");
const message = document.getElementById("message");

const currentPhoneSection = document.getElementById("currentPhoneSection");
const currentPhone = document.getElementById("currentPhone");
const confirmPhoneBtn = document.getElementById("confirmPhoneBtn");
const editPhoneBtn = document.getElementById("editPhoneBtn");
const phoneForm = document.getElementById("phoneForm");
const phoneMessage = document.getElementById("phoneMessage");

const whatsappMessage = document.getElementById("whatsappMessage");
const sendWhatsappBtn = document.getElementById("sendWhatsappBtn");
const whatsappStatus = document.getElementById("whatsappStatus");

const getSandboxInviteBtn = document.getElementById("getSandboxInviteBtn");
const sandboxStatus = document.getElementById("sandboxStatus");
const sandboxLink = document.getElementById("sandboxLink");
const sandboxGuide = document.getElementById("sandboxGuide");

let currentUser = null;
let isSandboxRegistered = false;

// Toggle login/register
toggleForm.addEventListener("click", () => {
  loginForm.classList.toggle("hidden");
  registerForm.classList.toggle("hidden");
  message.textContent = "";
});

// LOGIN
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  try {
    const res = await fetch(`${API}/login`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    message.textContent = data.message || "Error logging in";
    message.style.color = res.ok ? "#00ff88" : "#ff5555";

    if(res.ok){
      currentUser = { email };
      authContainer.classList.add("hidden");
      phoneContainer.classList.remove("hidden");
      await autofillPhone();
    }
  } catch(err){
    message.textContent = "‚ùå Cannot connect to server";
    message.style.color = "#ff5555";
  }
});

// REGISTER
registerForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const password = document.getElementById("regPassword").value.trim();
  try {
    const res = await fetch(`${API}/register`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({name,email,password})
    });
    const data = await res.json();
    message.textContent = data.message || "Error registering";
    message.style.color = res.ok ? "#00ff88" : "#ff5555";

    if(res.ok){
      currentUser = { email };
      authContainer.classList.add("hidden");
      phoneContainer.classList.remove("hidden");
      await autofillPhone();
    }
  } catch(err){
    message.textContent = "‚ùå Cannot connect to server";
    message.style.color = "#ff5555";
  }
});

// AUTOFILL PHONE
async function autofillPhone(){
  try {
    const res = await fetch(`${API}/phone/${currentUser.email}`);
    if(!res.ok){
      phoneForm.classList.remove("hidden");
      currentPhoneSection.classList.add("hidden");
      return;
    }
    const data = await res.json();
    if(data.phone){
      currentPhone.textContent = data.phone;
      currentPhoneSection.classList.remove("hidden");
      phoneForm.classList.add("hidden");
      isSandboxRegistered = data.sandbox_registered || false;
    } else {
      phoneForm.classList.remove("hidden");
      currentPhoneSection.classList.add("hidden");
    }
  } catch(err){
    console.error(err);
    phoneForm.classList.remove("hidden");
    currentPhoneSection.classList.add("hidden");
  }
}

// Confirm/Edit phone buttons
confirmPhoneBtn.addEventListener("click", () => {
  phoneContainer.classList.add("hidden");
  if(isSandboxRegistered){
    whatsappContainer.classList.remove("hidden");
  } else {
    showSandboxSection();
  }
});

editPhoneBtn.addEventListener("click", () => {
  currentPhoneSection.classList.add("hidden");
  phoneForm.classList.remove("hidden");
});

// SAVE PHONE INFO
phoneForm.addEventListener("submit", async(e)=>{
  e.preventDefault();
  const payload = {
    email: currentUser.email,
    phone: document.getElementById("phoneNumber").value.trim(),
    country: document.getElementById("country").value.trim(),
    city: document.getElementById("phoneCity").value.trim()
  };
  try{
    const res = await fetch(`${API}/phone`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    phoneMessage.textContent = data.message || "Error saving phone info";
    phoneMessage.style.color = res.ok ? "#00ff88" : "#ff5555";
    if(res.ok){
      phoneForm.classList.add("hidden");
      currentPhone.textContent = payload.phone;
      currentPhoneSection.classList.remove("hidden");
      isSandboxRegistered=false;
    }
  } catch(err){
    phoneMessage.textContent="‚ùå Cannot connect to server";
    phoneMessage.style.color="#ff5555";
  }
});

// SHOW SANDBOX SECTION
function showSandboxSection(){
  phoneContainer.classList.add("hidden");
  whatsappContainer.classList.remove("hidden");
  sandboxGuide.classList.remove("hidden");
}

// WHATSAPP LOGIC
sendWhatsappBtn.addEventListener("click", async()=>{
  if(!isSandboxRegistered){
    alert("‚ùå You must join the Sandbox first!");
    return;
  }
  const text = whatsappMessage.value.trim();
  if(!text) return alert("Please type a message first!");
  try{
    const res = await fetch(`${API}/send-whatsapp`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({email:currentUser.email,message:text})
    });
    const data = await res.json();
    whatsappStatus.textContent = data.message || "Error sending message";
    whatsappStatus.style.color = res.ok ? "#00ff88" : "#ff5555";
  } catch(err){
    whatsappStatus.textContent="‚ùå Cannot connect to server";
    whatsappStatus.style.color="#ff5555";
  }
});

// GET SANDBOX INVITE
getSandboxInviteBtn.addEventListener("click", async () => {
  try {
    const res = await fetch(`${API}/sandbox-invite`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: currentUser.email })
    });
    const data = await res.json();
    sandboxStatus.textContent = data.message || "Invite ready";
    sandboxStatus.style.color = res.ok ? "#00ff88" : "#ff5555";
    if(res.ok){
      sandboxLink.href = data.link;
      sandboxLink.classList.remove("hidden");

      // REVERSED ORDER: open link first, then mark as registered
      sandboxLink.onclick = async (e) => {
        e.preventDefault();
        // Open Twilio Sandbox link first
        window.open(data.link, "_blank");

        // Wait a bit before marking as registered
        setTimeout(async () => {
          try {
            await fetch(`${API}/mark-sandbox-registered`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email: currentUser.email })
            });
            isSandboxRegistered = true;
            sandboxGuide.classList.add("hidden");
            alert("‚úÖ Sandbox registration confirmed! You can now send messages.");
          } catch (err) {
            console.error("Error marking sandbox:", err);
          }
        }, 500);
      };
    }
  } catch (err) {
    sandboxStatus.textContent = "‚ùå Cannot connect to server";
    sandboxStatus.style.color = "#ff5555";
  }
});
</script>
</body>
</html>